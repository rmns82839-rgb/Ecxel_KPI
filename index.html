<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validador Profesional Fijo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --ticket-blue: #0d47a1; --orden-blue: #bbdefb; --success-bg: #a5d6a7;  
            --warning-bg: #ffb74d; --danger-bg: #ffcdd2; --empty-bg: #fff9c4; 
            --duplicate-bg: #e1bee7; /* MORADO */
            --zebra-gray: #e0e0e0; --border: #bcbcbc;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; margin: 0; padding: 5px; padding-bottom: 110px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 8px; }
        
        .firma-input-container { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
        .firma-input-container label { font-size: 11px; font-weight: bold; color: #37474f; }
        .input-text { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; flex-grow: 1; max-width: 300px; }

        .upload-area { border: 2px dashed #1a73e8; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 10px; background: #f1f8ff; }
        
        .table-wrapper { width: 100%; max-height: 70vh; overflow: auto; border: 1px solid var(--border); border-radius: 4px; position: relative; }
        table { border-collapse: collapse; width: max-content; min-width: 100%; background: white; table-layout: fixed; } 
        
        th { 
            background: #263238; color: white; padding: 8px 4px; font-size: 9px; 
            text-transform: uppercase; position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 2px 2px rgba(0,0,0,0.2);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        td { padding: 5px 6px; border: 1px solid #cfd8dc; font-size: 11px; color: #212121; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .col-accion { width: 45px !important; text-align: center; }
        .col-compacta { width: 75px; } /* Ancho reducido solicitado */
        .col-ticket { background-color: var(--ticket-blue) !important; color: white !important; font-weight: bold; text-align: center; width: 85px; }
        .col-orden { background-color: var(--orden-blue) !important; color: #0d47a1 !important; font-weight: bold; text-align: center; width: 90px; }

        .is-empty { background-color: var(--empty-bg) !important; } 
        tr:nth-child(even) { background-color: var(--zebra-gray); }
        
        /* L√ìGICA DE COLORES Y ESTILOS */
        tr.is-cancelled { background-color: var(--danger-bg) !important; text-decoration: none !important; } /* Sin subrayado */
        tr.date-warning { background-color: var(--warning-bg) !important; }
        tr.is-duplicate { background-color: var(--duplicate-bg) !important; } 
        
        /* El verde solo si no hay alerta */
        tr.checked:not(.is-cancelled):not(.date-warning):not(.is-duplicate) { 
            background-color: var(--success-bg) !important; 
        }
        
        .firma-display { font-family: 'Dancing Script', cursive; font-size: 26px; color: #1a237e; margin-top: 15px; border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 200px; text-align: center; }
        .btn-confirm { display: none; background: #e65100; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #263238; display: flex; padding: 12px 8px; gap: 6px; z-index: 1000; align-items: center; }
        .btn { padding: 14px 5px; border: none; border-radius: 6px; font-weight: bold; color: white; font-size: 13px; flex: 1; cursor: pointer; }
        .btn-undo, .btn-redo { background: #5c6bc0; flex: 0.4; }
        .btn-print { background: #546e7a; }
        .btn-excel { background: #2e7d32; }
        .btn-clear { background: #c62828; flex: 0.3; }
        .counter { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #ffd600; color: #000; padding: 2px 15px; border-radius: 10px; font-weight: bold; font-size: 11px; white-space: nowrap; }

        @media print {
            .bottom-bar, .upload-area, .firma-input-container, .btn-confirm { display: none !important; }
            .table-wrapper { max-height: none !important; overflow: visible !important; }
            #firmaFooter { display: block !important; }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="firma-input-container">
        <label>RESPONSABLE:</label>
        <input type="text" id="nombreResponsable" class="input-text" placeholder="Firma..." oninput="updateFirma()">
    </div>

    <div class="upload-area" onclick="document.getElementById('fileIn').click()">
        <input type="file" id="fileIn" accept=".xlsx, .xls, .csv" style="display:none">
        <h3>üìÇ Cargar Archivo</h3>
        <span id="fileNameDisplay" style="color:#666; font-size:0.7rem;">(No hay archivo)</span>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead id="head"></thead>
            <tbody id="body"></tbody>
        </table>
    </div>

    <div id="firmaFooter" style="text-align: right; padding: 20px 0; display: none;">
        <div id="displayFirma" class="firma-display"></div>
        <div style="font-size: 10px; color: #333; font-weight: bold; margin-right: 50px;">Firma Digital</div>
    </div>
</div>

<div class="bottom-bar">
    <div id="count" class="counter">0/0 OK</div>
    <button onclick="undo()" class="btn btn-undo">‚Ü∂</button>
    <button onclick="redo()" class="btn btn-redo">‚Ü∑</button>
    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è</button>
    <button onclick="exportarExcel()" class="btn btn-excel">üíæ Excel</button>
    <button onclick="borrarProgreso()" class="btn btn-clear">üóëÔ∏è</button>
</div>

<script>
    let rowsData = [];
    let activeCols = [];
    let checkedIndices = new Set();
    let currentFileName = "";
    let history = [];
    let historyStep = -1;

    function updateFirma() {
        const nom = document.getElementById('nombreResponsable').value;
        document.getElementById('displayFirma').innerText = nom;
        document.getElementById('firmaFooter').style.display = nom ? 'block' : 'none';
        localStorage.setItem('val_firma_v9', nom);
    }

    function parseToCompare(dateStr) {
        if (!dateStr) return null;
        const p = String(dateStr).split('/');
        return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]) : null;
    }

    function getColStyleClass(name, index) {
        let n = name.toUpperCase();
        let list = [];
        if (index < 10) list.push("col-compacta");
        if (n.includes("TICKET")) list.push("col-ticket");
        if (n.includes("LABORATORIO") || n.includes("ORDEN FINAL")) list.push("col-orden");
        return list.join(" ");
    }

    window.onload = function() {
        const savedFirma = localStorage.getItem('val_firma_v9');
        if(savedFirma) { document.getElementById('nombreResponsable').value = savedFirma; updateFirma(); }
        const savedData = localStorage.getItem('last_session_data');
        if(savedData) {
            rowsData = JSON.parse(savedData);
            currentFileName = localStorage.getItem('last_session_file');
            activeCols = JSON.parse(localStorage.getItem('last_session_cols'));
            document.getElementById('fileNameDisplay').innerText = currentFileName;
            const savedProgress = localStorage.getItem('progress_' + currentFileName);
            checkedIndices = savedProgress ? new Set(JSON.parse(savedProgress)) : new Set();
            render();
        }
    };

    document.getElementById('fileIn').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        currentFileName = file.name;
        document.getElementById('fileNameDisplay').innerText = currentFileName;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array', cellDates: true});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ""});
            processData(raw);
        };
        reader.readAsArrayBuffer(file);
    });

    function processData(raw) {
        let hIdx = raw.findIndex(r => r.some(c => String(c).toUpperCase().includes("TICKET")));
        if(hIdx === -1) return alert("Error: TICKET no encontrado");
        let headerRow = raw[hIdx];
        activeCols = [];
        let map = {};
        headerRow.forEach((c, i) => {
            let name = String(c).trim().replace(/\n/g, " ");
            if(name !== "") { activeCols.push(name); map[name] = i; }
        });
        rowsData = [];
        raw.slice(hIdx + 1).forEach(row => {
            if(!row[map["TICKET"]]) return;
            let tickets = String(row[map["TICKET"]]).split(/\s+/).filter(t => t.length > 2);
            tickets.forEach(t => {
                let obj = {};
                activeCols.forEach(col => {
                    let val = row[map[col]];
                    if(col.toUpperCase().includes("FECHA") && val instanceof Date) {
                        let d = val.getDate().toString().padStart(2, '0');
                        let m = (val.getMonth() + 1).toString().padStart(2, '0');
                        val = `${d}/${m}/${val.getFullYear()}`;
                    }
                    obj[col] = val;
                });
                obj.TICKET = t;
                rowsData.push(obj);
            });
        });
        localStorage.setItem('last_session_data', JSON.stringify(rowsData));
        localStorage.setItem('last_session_file', currentFileName);
        localStorage.setItem('last_session_cols', JSON.stringify(activeCols));
        checkedIndices = new Set();
        addToHistory();
        render();
    }

    function render() {
        const head = document.getElementById('head');
        const body = document.getElementById('body');
        if(activeCols.length === 0) return;

        // L√ìGICA DE DUPLICADOS PARA ICONO
        const counts = {};
        const firstSeenIndex = {}; // Para saber cu√°l es el primero de cada ticket
        rowsData.forEach((r, idx) => {
            const t = String(r.TICKET).trim();
            if(!counts[t]) {
                counts[t] = 1;
                firstSeenIndex[t] = idx;
            } else {
                counts[t]++;
            }
        });

        head.innerHTML = `<tr><th class="col-accion">OK</th>${activeCols.map((c, i) => `<th class="${getColStyleClass(c, i)}">${c}</th>`).join('')}</tr>`;
        
        body.innerHTML = rowsData.map((row, i) => {
            const isChecked = checkedIndices.has(i);
            const isCancelled = Object.values(row).some(v => String(v).toUpperCase().includes("CANCELADO"));
            const tVal = String(row.TICKET).trim();
            const isRepetido = counts[tVal] > 1;
            const isNotTheFirst = isRepetido && firstSeenIndex[tVal] !== i;

            let dateWarning = false;
            const colAgen = activeCols.find(c => c.toUpperCase().includes("AGENDAMIENTO"));
            const colEnvio = activeCols.find(c => c.toUpperCase().includes("ENVIO"));
            if (colAgen && colEnvio) {
                const dA = parseToCompare(row[colAgen]);
                const dE = parseToCompare(row[colEnvio]);
                if (dA && dE && dA > dE) dateWarning = true;
            }

            let rowClass = isCancelled ? "is-cancelled" : (dateWarning ? "date-warning" : (isRepetido ? "is-duplicate" : ""));
            if (isChecked) rowClass += " checked";

            return `
            <tr id="row-${i}" class="${rowClass}" onclick="showConfirm(${i})">
                <td class="col-accion">
                    <button id="btn-c-${i}" class="btn-confirm" onclick="confirmRow(event, ${i})">OK</button>
                    <span id="lbl-${i}">${isChecked ? '‚úÖ' : 'üìë'}</span>
                </td>
                ${activeCols.map((c, idx) => {
                    let val = row[c];
                    let isEmpty = (!val || val === "") ? "is-empty" : "";
                    // Solo poner ‚ö†Ô∏è si es el segundo en adelante
                    if(c.toUpperCase().includes("TICKET") && isNotTheFirst) val = "‚ö†Ô∏è " + val;
                    return `<td class="${getColStyleClass(c, idx)} ${isEmpty}">${val || ""}</td>`;
                }).join('')}
            </tr>`;
        }).join('');
        
        updateCounter();
        saveProgress();
    }

    function updateCounter() {
        document.getElementById('count').innerText = `${checkedIndices.size}/${rowsData.length} OK`;
    }

    function showConfirm(i) {
        document.querySelectorAll('.btn-confirm').forEach(b => b.style.display = 'none');
        document.querySelectorAll('span[id^="lbl-"]').forEach(s => s.style.display = 'inline');
        if(checkedIndices.has(i)) {
            if(confirm("¬øQuitar marcado?")) { checkedIndices.delete(i); addToHistory(); render(); }
        } else {
            document.getElementById(`btn-c-${i}`).style.display = 'inline-block';
            document.getElementById(`lbl-${i}`).style.display = 'none';
        }
    }

    function confirmRow(e, i) { e.stopPropagation(); checkedIndices.add(i); addToHistory(); render(); }
    function addToHistory() { 
        const state = JSON.stringify([...checkedIndices]);
        if (historyStep >= 0 && state === history[historyStep]) return;
        history = history.slice(0, historyStep + 1); history.push(state); historyStep++; 
    }
    function undo() { if (historyStep > 0) { historyStep--; checkedIndices = new Set(JSON.parse(history[historyStep])); render(); } }
    function redo() { if (historyStep < history.length - 1) { historyStep++; checkedIndices = new Set(JSON.parse(history[historyStep])); render(); } }
    function saveProgress() { if(currentFileName) localStorage.setItem('progress_' + currentFileName, JSON.stringify([...checkedIndices])); }
    function borrarProgreso() { if(confirm("¬øBorrar todo?")) { localStorage.clear(); location.reload(); } }
    function exportarExcel() {
        const sel = [...checkedIndices].map(i => {
            let f = {}; activeCols.forEach(col => { f[col] = rowsData[i][col]; }); return f;
        });
        const ws = XLSX.utils.json_to_sheet(sel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Validados");
        XLSX.writeFile(wb, "VALIDADO_" + currentFileName);
    }
</script>
</body>
</html>
