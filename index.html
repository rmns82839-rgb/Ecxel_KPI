<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validador Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --ticket-blue: #0d47a1; 
            --orden-blue: #bbdefb;  
            --success-bg: #a5d6a7;  
            --warning-bg: #ffcc80; 
            --danger-bg: #ffcdd2; 
            --zebra-gray: #e0e0e0; 
            --border: #bcbcbc;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; margin: 0; padding: 10px; padding-bottom: 110px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 12px; }
        
        .upload-area { border: 2px dashed #1a73e8; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; background: #f1f8ff; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .upload-area h3 { margin: 0; color: #1a73e8; font-size: 0.9rem; }
        
        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid var(--border); border-radius: 4px; }
        table { border-collapse: collapse; width: 100%; min-width: 900px; background: white; }
        
        th { background: #263238; color: white; padding: 10px; font-size: 11px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border: 1px solid #cfd8dc; font-size: 13px; color: #212121; }

        tr:nth-child(even) { background-color: var(--zebra-gray); }
        
        .col-ticket { background-color: var(--ticket-blue) !important; color: white !important; font-weight: bold; text-align: center; }
        .col-orden { background-color: var(--orden-blue) !important; color: #0d47a1 !important; font-weight: bold; text-align: center; }
        
        tr.is-cancelled { background-color: var(--danger-bg) !important; }
        tr.date-warning { background-color: var(--warning-bg) !important; }
        tr.checked { background-color: var(--success-bg) !important; }
        
        .btn-confirm { display: none; background: #e65100; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 11px; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #263238; display: flex; padding: 10px; gap: 8px; z-index: 1000; align-items: center; }
        .btn { padding: 12px 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 12px; flex: 1; }
        .btn-undo { background: #5c6bc0; flex: 0.5; }
        .btn-redo { background: #5c6bc0; flex: 0.5; }
        .btn-print { background: #546e7a; }
        .btn-excel { background: #2e7d32; }
        .btn-clear { background: #c62828; flex: 0.3; }

        .counter { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); background: #ffd600; color: #000; padding: 2px 15px; border-radius: 10px; font-weight: bold; font-size: 11px; white-space: nowrap; }

        /* NUEVO CUADRO DE RESUMEN PARA IMPRESI√ìN */
        #print-summary { display: none; margin-bottom: 20px; border: 2px solid #000; padding: 10px; border-radius: 5px; background: #f9f9f9; }
        #print-summary h2 { margin-top: 0; font-size: 18px; border-bottom: 1px solid #000; padding-bottom: 5px; }
        .stat-box { display: flex; justify-content: space-around; font-size: 14px; font-weight: bold; }

        @media print {
            .bottom-bar, .upload-area, .btn-confirm, th:first-child, td:first-child { display: none !important; }
            #print-summary { display: block !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            tr.checked { background-color: #a5d6a7 !important; }
            tr.is-cancelled:not(.checked) { background-color: #ffcdd2 !important; }
            tr.date-warning:not(.checked):not(.is-cancelled) { background-color: #ffcc80 !important; }
        }
    </style>
</head>
<body>

<div id="print-summary">
    <h2>Resumen de Validaci√≥n</h2>
    <div class="stat-box">
        <span id="print-total">Total: 0</span>
        <span id="print-val">Validados: 0</span>
        <span id="print-pend">Pendientes: 0</span>
    </div>
</div>

<div class="card">
    <div class="upload-area" onclick="document.getElementById('fileIn').click()">
        <input type="file" id="fileIn" accept=".xlsx, .xls, .csv" style="display:none">
        <h3>üìÇ Subir Archivo</h3>
        <span id="fileNameDisplay" style="color:#666; font-size:0.7rem;">(Sin cargar)</span>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead id="head"></thead>
            <tbody id="body"></tbody>
        </table>
    </div>
</div>

<div class="bottom-bar">
    <div id="count" class="counter">0 de 0 OK</div>
    <button onclick="undo()" class="btn btn-undo" title="Deshacer">‚Ü∂</button>
    <button onclick="redo()" class="btn btn-redo" title="Rehacer">‚Ü∑</button>
    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Imprimir</button>
    <button onclick="exportarExcel()" class="btn btn-excel">üíæ Excel</button>
    <button onclick="borrarProgreso()" class="btn btn-clear">üóëÔ∏è</button>
</div>

<script>
    let rowsData = [];
    let activeCols = [];
    let checkedIndices = new Set();
    let currentFileName = "";
    let history = [];
    let historyStep = -1;

    window.onload = function() {
        const savedData = localStorage.getItem('last_session_data');
        const savedFile = localStorage.getItem('last_session_file');
        const savedCols = localStorage.getItem('last_session_cols');
        
        if(savedData && savedFile && savedCols) {
            rowsData = JSON.parse(savedData);
            currentFileName = savedFile;
            activeCols = JSON.parse(savedCols);
            document.getElementById('fileNameDisplay').innerText = currentFileName + " (Recuperado)";
            const savedProgress = localStorage.getItem('progress_' + currentFileName);
            checkedIndices = savedProgress ? new Set(JSON.parse(savedProgress)) : new Set();
            history = [JSON.stringify([...checkedIndices])];
            historyStep = 0;
            render();
        }
    };

    document.getElementById('fileIn').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        currentFileName = file.name;
        document.getElementById('fileNameDisplay').innerText = currentFileName;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ""});
            processData(raw);
        };
        reader.readAsArrayBuffer(file);
    });

    function parseSpanishDate(dateStr) {
        if (!dateStr) return null;
        if (typeof dateStr === 'string') {
            const parts = dateStr.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            const isoParts = dateStr.split('-');
            if (isoParts.length === 3) return new Date(isoParts[0], isoParts[1] - 1, isoParts[2]);
        }
        return null;
    }

    function processData(raw) {
        let hIdx = raw.findIndex(r => r.some(c => String(c).toUpperCase().includes("TICKET")));
        if(hIdx === -1) return alert("No se encontr√≥ columna TICKET");

        let headerRow = raw[hIdx];
        activeCols = [];
        let map = {};
        headerRow.forEach((c, i) => {
            let name = String(c).trim().replace(/\n/g, " ");
            if(name !== "") { activeCols.push(name); map[name] = i; }
        });

        rowsData = [];
        raw.slice(hIdx + 1).forEach(row => {
            if(!row[map["TICKET"]]) return;
            let tickets = String(row[map["TICKET"]]).split(/\s+/).filter(t => t.length > 2);
            tickets.forEach(t => {
                let obj = {};
                activeCols.forEach(col => {
                    let val = row[map[col]];
                    if(col.toUpperCase().includes("FECHA") && !isNaN(val) && val !== "" && typeof val === 'number') {
                        val = new Date(Math.round((val - 25569) * 86400 * 1000)).toLocaleDateString('es-ES');
                    }
                    obj[col] = val;
                });
                obj.TICKET = t;
                rowsData.push(obj);
            });
        });

        localStorage.setItem('last_session_data', JSON.stringify(rowsData));
        localStorage.setItem('last_session_file', currentFileName);
        localStorage.setItem('last_session_cols', JSON.stringify(activeCols));
        const saved = localStorage.getItem('progress_' + currentFileName);
        checkedIndices = saved ? new Set(JSON.parse(saved)) : new Set();
        history = [JSON.stringify([...checkedIndices])];
        historyStep = 0;
        render();
    }

    function render() {
        const head = document.getElementById('head');
        const body = document.getElementById('body');
        if(activeCols.length === 0) return;

        head.innerHTML = `<tr><th>Acci√≥n</th>${activeCols.map(c => `<th>${c}</th>`).join('')}</tr>`;
        
        body.innerHTML = rowsData.map((row, i) => {
            const isChecked = checkedIndices.has(i);
            let rowClass = "";
            const isCancelled = Object.values(row).some(v => String(v).toUpperCase().includes("CANCELADO"));
            if (isCancelled) rowClass = "is-cancelled";

            if (!isCancelled) {
                const colAgendamiento = activeCols.find(c => c.toUpperCase().includes("AGENDAMIENTO"));
                const colEnvio = activeCols.find(c => c.toUpperCase().includes("ENVIO RESULTADOS"));
                if (colAgendamiento && colEnvio) {
                    const dAgen = parseSpanishDate(row[colAgendamiento]);
                    const dEnv = parseSpanishDate(row[colEnvio]);
                    if (dAgen && dEnv && dAgen > dEnv) rowClass = "date-warning";
                }
            }

            return `
            <tr id="row-${i}" class="${isChecked ? 'checked' : rowClass}" onclick="showConfirm(${i})">
                <td style="text-align:center;">
                    <button id="btn-c-${i}" class="btn-confirm" onclick="confirmRow(event, ${i})">OK?</button>
                    <span id="lbl-${i}">${isChecked ? '‚úÖ' : 'üìë'}</span>
                </td>
                ${activeCols.map(c => {
                    let cls = (c.toUpperCase() === "TICKET") ? "col-ticket" : (c.toUpperCase().includes("LABORATORIO") ? "col-orden" : "");
                    return `<td class="${cls}">${row[c]}</td>`;
                }).join('')}
            </tr>`;
        }).join('');
        saveProgress();
        updateCounter();
    }

    function updateCounter() {
        const total = rowsData.length;
        const validados = checkedIndices.size;
        const pendientes = total - validados;
        
        // Actualizar barra inferior
        document.getElementById('count').innerText = `${validados} de ${total} validados`;
        
        // Actualizar resumen de impresi√≥n
        document.getElementById('print-total').innerText = `Total Pacientes: ${total}`;
        document.getElementById('print-val').innerText = `Validados (OK): ${validados}`;
        document.getElementById('print-pend').innerText = `Pendientes: ${pendientes}`;
    }

    function showConfirm(i) {
        document.querySelectorAll('.btn-confirm').forEach(b => b.style.display = 'none');
        document.querySelectorAll('span[id^="lbl-"]').forEach(s => s.style.display = 'inline');
        if(checkedIndices.has(i)) {
            if(confirm("¬øQuitar marcado?")) {
                checkedIndices.delete(i);
                addToHistory();
                render();
            }
        } else {
            document.getElementById(`btn-c-${i}`).style.display = 'inline-block';
            document.getElementById(`lbl-${i}`).style.display = 'none';
        }
    }

    function confirmRow(e, i) {
        e.stopPropagation();
        checkedIndices.add(i);
        addToHistory();
        render();
    }

    function addToHistory() {
        const state = JSON.stringify([...checkedIndices]);
        if (state === history[historyStep]) return;
        history = history.slice(0, historyStep + 1);
        history.push(state);
        historyStep++;
        if(history.length > 30) { history.shift(); historyStep--; }
    }

    function undo() {
        if (historyStep > 0) {
            historyStep--;
            checkedIndices = new Set(JSON.parse(history[historyStep]));
            render();
        }
    }

    function redo() {
        if (historyStep < history.length - 1) {
            historyStep++;
            checkedIndices = new Set(JSON.parse(history[historyStep]));
            render();
        }
    }

    function saveProgress() {
        if(currentFileName) {
            localStorage.setItem('progress_' + currentFileName, JSON.stringify([...checkedIndices]));
        }
    }

    function borrarProgreso() {
        if(confirm("¬øBorrar todo el progreso y la sesi√≥n actual?")) {
            checkedIndices.clear();
            localStorage.clear();
            location.reload();
        }
    }

    function exportarExcel() {
        if(checkedIndices.size === 0) return alert("No hay datos validados");
        const selected = [...checkedIndices].map(i => rowsData[i]);
        const ws = XLSX.utils.json_to_sheet(selected);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Validados");
        XLSX.writeFile(wb, "Procesado_" + currentFileName);
    }
</script>
</body>
</html>
